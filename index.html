<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>SAP Live Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        :root { --primary: #00ff41; --bg: #0a0a0a; --card: #161616; --error: #ff4444; }
        body { font-family: 'Consolas', monospace; background: var(--bg); color: #d0d0d0; margin: 0; padding: 10px; }
        .header { display: flex; justify-content: space-between; border-bottom: 2px solid var(--primary); padding: 10px; background: #111; position: sticky; top:0; }
        .log-list { display: flex; flex-direction: column; gap: 2px; margin-top: 10px; }
        .log-row { background: var(--card); display: grid; grid-template-columns: 160px 140px 50px 160px 1fr auto; gap: 12px; padding: 8px 15px; align-items: center; font-size: 0.82rem; border-left: 4px solid #444; }
        .iflow { color: #00d4ff; font-weight: bold; }
        details { grid-column: 1 / -1; background: #000; padding: 5px; border: 1px solid #222; }
        pre { font-size: 0.75rem; color: #88c0d0; margin: 0; white-space: pre-wrap; word-break: break-all; }
        .btn { cursor: pointer; background: #222; color: #fff; border: 1px solid #444; padding: 5px 15px; border-radius: 4px; }
    </style>
</head>
<body>
    <div class="header">
        <h2 style="margin:0; font-size:1rem; color:var(--primary)">üõ∞Ô∏è SAP MONITOR <span id="st">üî¥</span></h2>
        <button class="btn" onclick="fetchLogs()">üîÑ Recarga Manual</button>
    </div>
    <div id="log-list" class="log-list"></div>

    <script>
        const SB_URL = 'https://miveeslsnfeumtkececq.supabase.co';
        const SB_KEY = 'sb_publishable_az5Yozx0Xo_LMhR6LC6z4Q_06tkGadT'; 
        const _supabase = supabase.createClient(SB_URL, SB_KEY);

        async function fetchLogs() {
            const { data, error } = await _supabase.from('sap_logs').select('*').order('created_at', { ascending: false }).limit(20);
            if (!error) render(data, false);
            else console.error("Error Fetch:", error.message);
        }

        function initRealtime() {
            const channel = _supabase.channel('db-changes')
                .on('postgres_changes', { event: 'INSERT', schema: 'public', table: 'sap_logs' }, p => render([p.new], true))
                .subscribe((status) => {
                    console.log("Estado:", status);
                    const dot = document.getElementById('st');
                    if (status === 'SUBSCRIBED') { dot.innerText = 'üü¢'; dot.style.color = '#00ff41'; }
                    if (status === 'CHANNEL_ERROR') { dot.innerText = 'üü° (Error de R√©plica)'; dot.style.color = 'yellow'; }
                });
        }

        function render(logs, isNew) {
            const list = document.getElementById('log-list');
            const html = logs.map(log => `
                <div class="log-row">
                    <span style="color:#777">${log.log_time_stamp || ''}</span>
                    <span class="iflow">${log.iflow_name || 'SAP'}</span>
                    <span style="color:var(--primary)">#${log.step_number || '0'}</span>
                    <span style="color:#e91e63">${log.step_name || ''}</span>
                    <span>${log.description || ''}</span>
                    <details><summary style="cursor:pointer; color:var(--primary)">DATA</summary><pre>${log.payload}</pre></details>
                </div>`).join('');
            isNew ? list.insertAdjacentHTML('afterbegin', html) : list.innerHTML = html;
        }

        fetchLogs();
        initRealtime();
    </script>
</body>
</html>
