<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>SAP Live Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
    <style>
        :root { --primary: #00ff41; --bg: #0a0a0a; --card: #161616; --error: #ff4444; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); color: #d0d0d0; margin: 0; padding: 10px; }
        .header { display: flex; justify-content: space-between; border-bottom: 2px solid var(--primary); padding: 5px 15px; background: #111; align-items: center; }
        .log-list { display: flex; flex-direction: column; gap: 2px; margin-top: 10px; }
        /* Fila de un solo rengl√≥n */
        .log-row { 
            background: var(--card); display: grid; grid-template-columns: 160px 140px 50px 160px 1fr 100px; 
            gap: 12px; padding: 6px 15px; align-items: center; font-size: 0.82rem; border-left: 4px solid #444;
        }
        .log-row.error-row { border-left-color: var(--error); animation: blink 1s infinite; }
        @keyframes blink { 0% { background: #161616; } 50% { background: #330000; } 100% { background: #161616; } }
        .iflow { color: #00d4ff; font-weight: bold; }
        details { grid-column: 1 / -1; background: #000; padding: 5px; border: 1px solid #222; }
        pre { font-size: 0.75rem; color: #88c0d0; margin: 0; white-space: pre-wrap; }
    </style>
</head>
<body>
    <div class="header">
        <h2 style="margin:0; font-size:1rem; color:var(--primary)">üõ∞Ô∏è SAP REAL-TIME MONITOR <span id="st">üî¥</span></h2>
        <button onclick="fetchLogs()" style="cursor:pointer; background:#222; color:#fff; border:1px solid #444; border-radius:3px; padding:4px 12px;">üîÑ Forzar Carga</button>
    </div>
    <div id="log-list" class="log-list"></div>

    <script>
        const SB_URL = 'https://miveeslsnfeumtkececq.supabase.co';
        const SB_KEY = 'sb_publishable_az5Yozx0Xo_LMhR6LC6z4Q_06tkGadT'; 
        const _supabase = supabase.createClient(SB_URL, SB_KEY);

        async function fetchLogs() {
            const { data, error } = await _supabase.from('sap_logs').select('*').order('created_at', { ascending: false }).limit(40);
            if (!error) render(data, false);
        }

        function initRealtime() {
            _supabase.channel('logs').on('postgres_changes', { event: 'INSERT', schema: 'public', table: 'sap_logs' }, p => render([p.new], true))
            .subscribe(s => { if(s==='SUBSCRIBED') document.getElementById('st').innerText = 'üü¢'; });
        }

        function render(logs, isNew) {
            const list = document.getElementById('log-list');
            const html = logs.map(log => `
                <div class="log-row ${log.status !== 'LOG' ? 'error-row' : ''}">
                    <span style="color:#777">${log.log_time_stamp}</span>
                    <span class="iflow">${log.iflow_name}</span>
                    <span style="color:var(--primary); font-weight:bold; text-align:center;">${log.step_number}</span>
                    <span style="color:#e91e63; font-weight:bold;">${log.step_name}</span>
                    <span style="color:#aaa; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">${log.description}</span>
                    <details><summary style="cursor:pointer; color:var(--primary)">DATA</summary><pre>${log.payload}</pre></details>
                </div>`).join('');
            isNew ? list.insertAdjacentHTML('afterbegin', html) : list.innerHTML = html;
        }

        fetchLogs(); initRealtime();
    </script>
</body>
</html>