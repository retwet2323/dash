<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SAP Live Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        :root { --primary: #00ff41; --bg: #0a0a0a; --card: #161616; --error: #ff4444; }
        body { font-family: 'Consolas', monospace; background: var(--bg); color: #d0d0d0; margin: 0; padding: 10px; }
        .header { display: flex; justify-content: space-between; border-bottom: 2px solid var(--primary); padding: 5px 15px; background: #111; align-items: center; position: sticky; top: 0; z-index: 100; }
        .log-list { display: flex; flex-direction: column; gap: 2px; margin-top: 10px; }
        .log-row { 
            background: var(--card); display: grid; grid-template-columns: 160px 140px 50px 160px 1fr auto; 
            gap: 12px; padding: 8px 15px; align-items: center; font-size: 0.82rem; border-left: 4px solid #444;
        }
        .log-row:hover { background: #222; }
        .iflow { color: #00d4ff; font-weight: bold; }
        .st-dot { font-size: 1.2rem; margin-left: 10px; }
        details { grid-column: 1 / -1; background: #000; padding: 5px; border: 1px solid #222; }
        pre { font-size: 0.75rem; color: #88c0d0; margin: 0; white-space: pre-wrap; word-break: break-all; }
        .btn { cursor: pointer; background: #222; color: #fff; border: 1px solid #444; border-radius: 3px; padding: 4px 12px; }
    </style>
</head>
<body>
    <div class="header">
        <h2 style="margin:0; font-size:1rem; color:var(--primary)">üõ∞Ô∏è SAP REAL-TIME MONITOR <span id="st" class="st-dot">üî¥</span></h2>
        <button class="btn" onclick="fetchLogs()">üîÑ Cargar Manual</button>
    </div>
    <div id="log-list" class="log-list"></div>

    <script>
        // VERIFICA ESTOS DATOS EN SETTINGS > API
        const SB_URL = 'https://miveeslsnfeumtkececq.supabase.co';
        const SB_KEY = 'sb_publishable_az5Yozx0Xo_LMhR6LC6z4Q_06tkGadT'; 

        const _supabase = supabase.createClient(SB_URL, SB_KEY, {
            realtime: { params: { eventsPerSecond: 10 } }
        });

        async function fetchLogs() {
            const { data, error } = await _supabase
                .from('sap_logs')
                .select('*')
                .order('created_at', { ascending: false })
                .limit(40);
            
            if (error) {
                console.error("Error en Fetch:", error.message);
                document.getElementById('st').title = "Error: " + error.message;
            } else {
                render(data, false);
            }
        }

        function initRealtime() {
            const channel = _supabase
                .channel('db-changes')
                .on('postgres_changes', { event: 'INSERT', schema: 'public', table: 'sap_logs' }, p => {
                    console.log("¬°Nuevo registro!", p.new);
                    render([p.new], true);
                })
                .subscribe((status) => {
                    console.log("Estado suscripci√≥n:", status);
                    if (status === 'SUBSCRIBED') {
                        document.getElementById('st').innerText = 'üü¢';
                    } else if (status === 'CHANNEL_ERROR') {
                        document.getElementById('st').innerText = 'üü°';
                        console.error("Error de canal: Revisa si Realtime est√° activo en la tabla.");
                    }
                });
        }

        function render(logs, isNew) {
            const list = document.getElementById('log-list');
            const html = logs.map(log => `
                <div class="log-row">
                    <span style="color:#777">${log.log_time_stamp || '---'}</span>
                    <span class="iflow">${log.iflow_name || 'SAP'}</span>
                    <span style="color:var(--primary); font-weight:bold; text-align:center;">${log.step_number || '0'}</span>
                    <span style="color:#e91e63; font-weight:bold;">${log.step_name || 'Step'}</span>
                    <span style="color:#aaa">${log.description || ''}</span>
                    <details><summary style="cursor:pointer; color:var(--primary)">DATA</summary><pre>${log.payload}</pre></details>
                </div>`).join('');
            
            if (isNew) { list.insertAdjacentHTML('afterbegin', html); } 
            else { list.innerHTML = html; }
        }

        fetchLogs();
        initRealtime();
    </script>
</body>
</html>
