<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>SAP Live Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        :root { --primary: #00ff41; --bg: #0a0a0a; --card: #161616; }
        body { font-family: 'Consolas', monospace; background: var(--bg); color: #d0d0d0; margin: 0; padding: 10px; }
        .header { display: flex; justify-content: space-between; border-bottom: 2px solid var(--primary); padding: 10px; background: #111; }
        .log-row { 
            background: var(--card); display: grid; grid-template-columns: 160px 140px 50px 160px 1fr 80px; 
            gap: 12px; padding: 10px; align-items: center; border-bottom: 1px solid #222; font-size: 0.85rem;
        }
        .iflow { color: #00d4ff; font-weight: bold; }
        .st-dot { font-size: 1.2rem; }
        pre { background: #000; padding: 10px; color: #88c0d0; font-size: 0.75rem; white-space: pre-wrap; }
    </style>
</head>
<body>
    ++++++++++++++++++++++++++++++++++++++++
    <div class="header">
        <h2 style="margin:0; font-size:1rem; color:var(--primary)">üõ∞Ô∏è SAP REAL-TIME MONITOR <span id="st" class="st-dot">üî¥</span></h2>
        <button onclick="fetchLogs()" style="cursor:pointer; background:#222; color:#fff; border:1px solid #444; padding:5px 15px;">üîÑ Cargar Manual</button>
    </div>
    <div id="log-list"></div>

    <script>
        // REPEGA TUS CLAVES AQU√ç DESDE SETTINGS > API
        const SB_URL = 'https://miveeslsnfeumtkececq.supabase.co';
        const SB_KEY = 'sb_publishable_az5Yozx0Xo_LMhR6LC6z4Q_06tkGadT'; // Aseg√∫rate que sea la ANON_KEY completa

        const _supabase = supabase.createClient(SB_URL, SB_KEY);

        async function fetchLogs() {
            const { data, error } = await _supabase.from('sap_logs').select('*').order('created_at', { ascending: false }).limit(20);
            if (error) {
                console.error("ERROR DE AUTORIZACI√ìN:", error.message);
                alert("Error 401: La clave API no es v√°lida o RLS est√° bloqueando.");
            } else {
                render(data, false);
            }
        }

        function initRealtime() {
            _supabase.channel('custom-filter-channel')
            .on('postgres_changes', { event: 'INSERT', schema: 'public', table: 'sap_logs' }, p => render([p.new], true))
            .subscribe((status) => {
                console.log("Estado suscripci√≥n:", status);
                if (status === 'SUBSCRIBED') document.getElementById('st').innerText = 'üü¢';
                if (status === 'CHANNEL_ERROR') document.getElementById('st').innerText = 'üü° (Error de Canal)';
            });
        }

        function render(logs, isNew) {
            const list = document.getElementById('log-list');
            const html = logs.map(log => `
                <div class="log-row">
                    <span style="color:#777">${log.log_time_stamp || ''}</span>
                    <span class="iflow">${log.iflow_name || 'SAP'}</span>
                    <span style="color:var(--primary)">#${log.step_number || '0'}</span>
                    <span style="color:#e91e63">${log.step_name || ''}</span>
                    <span>${log.description || ''}</span>
                    <details><summary style="cursor:pointer; color:var(--primary)">DATA</summary><pre>${log.payload}</pre></details>
                </div>`).join('');
            isNew ? list.insertAdjacentHTML('afterbegin', html) : list.innerHTML = html;
        }

        fetchLogs();
        initRealtime();
    </script>
</body>
</html>
